// Dependencies
import React from 'react'
import { useSelector, useDispatch } from 'react-redux';
import { Link } from 'react-router-dom';

// Externals
import { getTotalBasketPrice, getPhoneById } from 'services/selectors';
import { removePhoneFromBasketById, cleanAllBasket, basketCheckout } from 'actions'


const Basket = () => {
  const dispatch = useDispatch()
  const basket = useSelector((state) => state.basket)
  const phonesObj = useSelector((state) => state.phonesObj)

  const totalPrice = getTotalBasketPrice(basket, phonesObj)

  //Функции для добавления в объект поля "count:количества повторов телефона"
  // 0) Создаем массив уникальных ID
  const uniquesIds = [...new Set(basket)]
  // 1) Получаем массив объектов - телефонов из списка уникальных IDшников
  const phonesArray = uniquesIds.reduce((totalArr, itemId) => {
    totalArr.push(getPhoneById(phonesObj, itemId))
    return totalArr
  }, [])
  //3) Фильтруем уникальные ключи и выводим число повторяющихся значений
  const phoneCount = (id) => {
    let phoneCount = basket.filter((basketId) => basketId === id)
    return phoneCount.length
  }
  // 2) Модифицируем объект телефона чтобы добать ему поле count
  const phonesWithCount = phonesArray.map((phone) => {
    return {
      ...phone,
      count: phoneCount(phone.id)
    }
  })

  // Флаг наличия элементов в корзине
  const isBasketEmpty = uniquesIds.length === 0 ? true : false

  const renderContent = () => {
    return (
      <div>
        {isBasketEmpty ?
          <div> Your shopping cart is empty</div>
          :
          <div className='table-responsive'>
            <table className='table-bordered table-striped table-condensed cf'>
              <tbody>
                {phonesWithCount.map((phone, index) => (
                  <tr key={index} className='item-checout'>
                    <td className='first-column-checkout'>
                      <img className='img-thumbnail' src={phone.image} alt={phone.name} />
                    </td>
                    <td>{phone.name}</td>
                    <td>${phone.price}</td>
                    <td>{phone.count}</td>
                    <td><span onClick={() => dispatch(removePhoneFromBasketById(phone.id))} className='delete-cart'></span></td>
                  </tr>
                ))}
              </tbody>
            </table>
          </div>}

        {!isBasketEmpty &&
          <div className='row'>
            <div className='pull-right total-user-chekout'>
              <b>Total:</b>
              ${totalPrice}
            </div>
          </div>}

      </div>)
  }

  const renderSidebar = () => {
    return (
      <div>
        <Link to='/' className='btn btn-info'>
          <span className='glyphicon glyphicon-info-sign'></span>
          <span>Continue shopping</span>
        </Link>
        {!isBasketEmpty &&
          <div>
            <button onClick={() => dispatch(cleanAllBasket)} className='btn btn-danger'>
              <span className='glyphicon glyphicon-trash'>Clean cart</span>
            </button>
            <button onClick={() => basketCheckout(phonesWithCount)} className='btn btn-success'>
              <span className='glyphicon glyphicon-envelope'>Checkout</span>
            </button>

          </div>
        }
      </div>)
  }

  return (
    <div className='view-container'>
      <div className='container'>
        <div className='row'>
          <div className='col-md-9'>{renderContent()}</div>
          <div className='col-md-3 btn-user-checkout'>{renderSidebar()}</div>
        </div>
      </div>

    </div>
  )
}

export default Basket;
